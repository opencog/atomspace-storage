Overview
========

The AtomSpacePublisherModule class publishes AtomSpace change events
across the network using [ZeroMQ sockets](http://zeromq.org) to allow for external
clients to receive updates from the AtomSpace via a publish/subscribe
pattern.

Clients can subscribe to the events by subscribing to a ZeroMQ socket.

Supported events are:

-   add
-   remove
-   tvchanged
-   avchanged

The message is a JSON-formatted string that follows the same conventions
as the [REST API](http://wiki.opencog.org/w/Web_interface).

Configuration
=============

Prerequisites
-------------

Requires ZeroMQ 3.2.4 (libzmq3-dev)

This will be installed automatically if you are using ocpkg, or can be
installed manually here: <http://zeromq.org/intro:get-the-software>

Module
------

This is implemented as a Module named *libatomspacepublisher.so* which must be enabled in the *opencog.conf* file.

Parameters
----------

The default configuration parameters in opencog.conf are:

`  ZMQ_EVENT_USE_PUBLIC_IP = TRUE`

`  ZMQ_EVENT_PORT = 5563`

### ZMQ\_EVENT\_USE\_PUBLIC\_IP

If set to TRUE, this parameter will allow ZeroMQ to publish AtomSpace
events to the public internet. If set to FALSE, ZeroMQ will publish
events to localhost.

### ZMQ\_EVENT\_PORT

This is the port that ZeroMQ will use to publish AtomSpace events.

Message format
==============

Atom object
-----------

### Format

    {
	    "atoms": {
	        "handle": UUID,
	        "type": TYPENAME,
	        "name": NAME,
	        "attentionvalue": {
	            "sti": STI,
	            "lti": LTI,
	            "vlti": VLTI
	        },
	        "truthvalue": {
	            "type": TRUTHVALUETYPE,
	            "details": TRUTHVALUEDETAILS 
	        },
	        "outgoing": "[ UUID1, UUID2 ... ]",
	        "incoming": "[ UUID1, UUID2 ... ]"
	    }
	}


#### UUID

integer

#### TYPENAME

*Atom type, see [OpenCog Atom types](http://wiki.opencog.org/w/OpenCog_Atom_types)*

string (choose from the list of available atom types)

#### NAME

string

#### STI

integer

#### LTI

integer

#### VLTI

boolean

#### TRUTHVALUETYPE

Valid types are:

-   simple
-   count
-   indefinite
-   composite

*see [TruthValue](http://wiki.opencog.org/w/TruthValue)*

#### TRUTHVALUEDETAILS

The format of the TRUTHVALUEDETAILS object depends on the value of the
TRUTHVALUETYPE parameter.

#### simple

    {
	    'count': TRUTHVALUECOUNT,
	    'confidence': TRUTHVALUECONFIDENCE,
	    'strength': TRUTHVALUESTRENGTH
	}

###### TRUTHVALUECOUNT
float

###### TRUTHVALUECONFIDENCE
float

###### TRUTHVALUESTRENGTH
float

#### count

    {
	    'count': TRUTHVALUECOUNT,
	    'confidence': TRUTHVALUECONFIDENCE,
	    'strength': TRUTHVALUESTRENGTH
	}

###### TRUTHVALUECOUNT
*(see above)*

###### TRUTHVALUECONFIDENCE
*(see above)*

###### TRUTHVALUESTRENGTH
*(see above)*

#### indefinite

	{
	    'strength': TRUTHVALUESTRENGTH,
	    'L': TRUTHVALUEL,
	    'U': TRUTHVALUEU,
	    'confidence': TRUTHVALUECONFIDENCE,
	    'diff': TRUTHVALUEDIFF,
	    'symmetric': TRUTHVALUESYMMETRIC
	}

###### TRUTHVALUECONFIDENCE
*(see above)*

###### TRUTHVALUESTRENGTH
*(see above)*

###### TRUTHVALUEL

###### TRUTHVALUEU

###### TRUTHVALUEDIFF

###### TRUTHVALUESYMMETRIC

Event types
===========

The AtomSpace change event publisher binds to Boost Signals2 signals generated by
the AtomSpace class.

The following event types are available:

add
---

Triggered whenever an atom is added.

ZeroMQ subscription channel name: **add**

remove
------

Triggered whenever an atom is removed.

ZeroMQ subscription channel name: **remove**

avchanged
---------

Triggered whenever the AttentionValue of an atom is changed.

ZeroMQ subscription channel name: **avchanged**

tvchanged
---------

Triggered whenever the TruthValue of an atom is changed.

ZeroMQ subscription channel name: **tvchanged**

Important note regarding redundant events
-----------------------------------------

Currently, the **AtomSpace** class triggers redundant events under certain
circumstances. It is important that you design your application to
properly handle these.

This has been noted in this open issue:
<https://github.com/opencog/opencog/issues/394>

The redundant signals are enumerated as follows:

-   Add atom
    - Adding a node triggers an *avchanged* event that can be disregarded, and then *add* event
    - Adding a link triggers an *avchanged* event that can be disregarded, and then *add* event, and then a *tvchanged* event that can be disregarded
-   Remove atom
    - Removing an atom triggers a *remove* event, and then an *avchanged* event that can be disregarded

Example clients
===============

Python
------

An example client is available here:

<https://github.com/opencog/external-tools/AtomSpaceSubscriber/SampleClient/client.py>

C++
---

Detailed examples of how to subscribe to events and parse the JSON using
Boost Property Trees can be found in the unit tests, located in:

`  tests/persist/zmq/events/AtomSpacePublisherModuleUTest.cxxtest`

JavaScript
----------

A server exists to forward ZeroMQ messages to socket.io sockets to allow
JavaScript web applications to subscribe to AtomSpace events, even
across domains.

To enable this server, follow the instructions in this file:

`  opencog/python/web/socketio/atomspace_publisher.py`

An example client application is available in this file:

`  opencog/python/web/socketio/index.html`
